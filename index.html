<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Заявление на возврат ДС — СМБ</title>
  <script src="https://cdn.jsdelivr.net/npm/docx@7.4.1/build/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    body {
      font-family: 'Times New Roman', serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #0056b3;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: inherit;
      font-size: 15px;
    }
    input.invalid {
      border-color: #e74c3c;
      background-color: #fff5f5;
    }
    button {
      width: 100%;
      padding: 14px;
      background-color: #0056b3;
      color: white;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #004299;
    }
    .note {
      font-size: 13px;
      color: #666;
      font-style: italic;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Заявление на возврат денежных средств</h1>

    <div class="form-group">
      <label>Наименование организации (ООО / ИП):</label>
      <input type="text" id="orgName" placeholder="ООО «Ромашка»">
    </div>

    <div class="form-group">
      <label>Номер договора:</label>
      <input type="text" id="contractNumber" placeholder="2025/09/10-1225866" oninput="formatContractNumber(this)">
    </div>

    <div class="form-group">
      <label>Сумма цифрами:</label>
      <input type="text" id="amountNumeric" placeholder="150000.00" oninput="updateAmountWords()">
    </div>

    <div class="form-group">
      <label>Сумма прописью:</label>
      <input type="text" id="amountWords" placeholder="сто пятьдесят тысяч рублей 00 копеек" readonly>
    </div>

    <div class="form-group">
      <label>Номер счёта:</label>
      <input type="text" id="accountNumber" placeholder="40702810123456789012" oninput="onlyDigits(this)">
    </div>

    <div class="form-group">
      <label>Причина возврата:</label>
      <textarea id="refundReason" rows="2" placeholder="Неверно выставлен счёт"></textarea>
    </div>

    <div class="form-group">
      <label>ИНН:</label>
      <input type="text" id="inn" placeholder="1234567890" oninput="onlyDigits(this)" maxlength="12">
    </div>

    <div class="form-group">
      <label>КПП (если ИП — оставьте пустым):</label>
      <input type="text" id="kpp" placeholder="123456789" oninput="onlyDigits(this)" maxlength="9">
      <div class="note">Для ИП строка КПП будет удалена из заявления.</div>
    </div>

    <div class="form-group">
      <label>Банк:</label>
      <input type="text" id="bank" placeholder="ПАО Сбербанк">
    </div>

    <div class="form-group">
      <label>Расчётный счёт:</label>
      <input type="text" id="checkingAccount" placeholder="40702810123456789012" oninput="onlyDigits(this)" maxlength="20">
    </div>

    <div class="form-group">
      <label>Корреспондентский счёт:</label>
      <input type="text" id="correspondentAccount" placeholder="30101810400000000225" oninput="onlyDigits(this)" maxlength="20">
    </div>

    <div class="form-group">
      <label>БИК:</label>
      <input type="text" id="bik" placeholder="044525225" oninput="onlyDigits(this)" maxlength="9">
    </div>

    <div class="form-group">
      <label>Должность руководителя:</label>
      <select id="directorTitle">
        <option value="Генеральный директор">Генеральный директор</option>
        <option value="Директор">Директор</option>
        <option value="ИП">ИП</option>
      </select>
    </div>

    <div class="form-group">
      <label>ФИО руководителя:</label>
      <input type="text" id="directorName" placeholder="Иванов Иван Иванович">
    </div>

    <button onclick="generateStatement()">Скачать заявление (.docx)</button>
  </div>

  <script>
    // Только цифры
    function onlyDigits(input) {
      input.value = input.value.replace(/\D/g, '');
      input.classList.remove('invalid');
    }

    // Маска для номера договора: ГГГГ/ММ/ДД-ЦИФРЫ
    function formatContractNumber(input) {
      let value = input.value.replace(/\D/g, ''); // оставляем только цифры

      // Ограничим общую длину: 4+2+2+7 = 15 цифр (можно увеличить при необходимости)
      if (value.length > 15) value = value.substring(0, 15);

      let formatted = '';
      if (value.length >= 4) {
        formatted = value.substring(0, 4);
        if (value.length >= 6) {
          formatted += '/' + value.substring(4, 6);
          if (value.length >= 8) {
            formatted += '/' + value.substring(6, 8);
            if (value.length > 8) {
              formatted += '-' + value.substring(8);
            }
          }
        }
      } else {
        formatted = value;
      }

      input.value = formatted;
      input.classList.remove('invalid');
    }

    // Валидация: ГГГГ/ММ/ДД-ЦИФРЫ (минимум одна цифра после тире)
    function validateContractNumber(value) {
      return /^\d{4}\/\d{2}\/\d{2}-\d+$/.test(value);
    }

    // === Остальной код без изменений ===
    const units = ["", "один", "два", "три", "четыре", "пять", "шесть", "семь", "восемь", "девять"];
    const unitsFem = ["", "одна", "две", "три", "четыре", "пять", "шесть", "семь", "восемь", "девять"];
    const teens = ["десять", "одиннадцать", "двенадцать", "тринадцать", "четырнадцать", "пятнадцать", "шестнадцать", "семнадцать", "восемнадцать", "девятнадцать"];
    const tens = ["", "", "двадцать", "тридцать", "сорок", "пятьдесят", "шестьдесят", "семьдесят", "восемьдесят", "девяносто"];
    const hundreds = ["", "сто", "двести", "триста", "четыреста", "пятьсот", "шестьсот", "семьсот", "восемьсот", "девятьсот"];

    function getThousandForm(n) {
      if (n % 100 > 10 && n % 100 < 20) return "тысяч";
      if (n % 10 === 1) return "тысяча";
      if (n % 10 === 2 || n % 10 === 3 || n % 10 === 4) return "тысячи";
      return "тысяч";
    }

    function getRubleForm(n) {
      if (n % 100 > 10 && n % 100 < 20) return "рублей";
      if (n % 10 === 1) return "рубль";
      if (n % 10 === 2 || n % 10 === 3 || n % 10 === 4) return "рубля";
      return "рублей";
    }

    function getKopeckForm(n) {
      if (n % 100 > 10 && n % 100 < 20) return "копеек";
      if (n % 10 === 1) return "копейка";
      if (n % 10 === 2 || n % 10 === 3 || n % 10 === 4) return "копейки";
      return "копеек";
    }

    function convertHundreds(n) {
      if (n === 0) return "";
      let result = "";
      let h = Math.floor(n / 100);
      let r = n % 100;
      if (h > 0) result += hundreds[h] + " ";
      if (r < 10) {
        if (r > 0) result += units[r] + " ";
      } else if (r < 20) {
        result += teens[r - 10] + " ";
      } else {
        let t = Math.floor(r / 10);
        let o = r % 10;
        result += tens[t] + " ";
        if (o > 0) result += units[o] + " ";
      }
      return result;
    }

    function numberToWordsRubles(num) {
      if (typeof num !== 'number' || isNaN(num) || num < 0 || num >= 1e9) {
        return "";
      }

      const rubles = Math.floor(num);
      const kopecks = Math.round((num - rubles) * 100);

      if (rubles === 0 && kopecks === 0) {
        return "ноль рублей 00 копеек";
      }

      let words = "";

      const millions = Math.floor(rubles / 1000000);
      const remainderAfterMillions = rubles % 1000000;
      if (millions > 0) {
        words += convertHundreds(millions) + " ";
        if (millions % 100 > 10 && millions % 100 < 20) words += "миллионов ";
        else if (millions % 10 === 1) words += "миллион ";
        else if ([2,3,4].includes(millions % 10)) words += "миллиона ";
        else words += "миллионов ";
      }

      const thousands = Math.floor(remainderAfterMillions / 1000);
      const remainder = remainderAfterMillions % 1000;
      if (thousands > 0) {
        let thousandWords = convertHundreds(thousands).replace(/один /, "одна ").replace(/два /, "две ");
        words += thousandWords + getThousandForm(thousands) + " ";
      }

      if (remainder > 0 || rubles === 0) {
        if (remainder === 0 && rubles > 0) {
        } else {
          words += convertHundreds(remainder);
        }
      }

      if (rubles === 0) {
        words = "ноль ";
      }
      words = words.trim();
      words += " " + getRubleForm(rubles);

      const kopeckWord = getKopeckForm(kopecks);
      const kopecksPadded = String(kopecks).padStart(2, '0');

      return (words + " " + kopecksPadded + " " + kopeckWord).trim();
    }

    function updateAmountWords() {
      const input = document.getElementById("amountNumeric").value.trim();
      if (input === "") {
        document.getElementById("amountWords").value = "";
        return;
      }

      const clean = input.replace(/[^0-9.,]/g, '').replace(',', '.');
      const num = parseFloat(clean);

      if (isNaN(num) || num < 0 || num >= 1e9) {
        document.getElementById("amountWords").value = "";
      } else {
        document.getElementById("amountWords").value = numberToWordsRubles(num);
      }
    }

    function getCurrentDate() {
      const now = new Date();
      return `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()}`;
    }

    function generateStatement() {
      const contractInput = document.getElementById("contractNumber");
      const contractValue = contractInput.value.trim();

      if (contractValue !== '' && !validateContractNumber(contractValue)) {
        alert('Номер договора должен быть в формате: ГГГГ/ММ/ДД-ЦИФРЫ (например: 2025/09/10-1225866)');
        contractInput.classList.add('invalid');
        contractInput.focus();
        return;
      }

      const orgName = document.getElementById("orgName").value.trim() || "[Наименование организации]";
      const contractNumber = contractValue || "[номер договора]";
      const amountNumeric = document.getElementById("amountNumeric").value.trim() || "[сумма]";
      let amountWords = document.getElementById("amountWords").value.trim();

      if (!amountWords) {
        const clean = amountNumeric.replace(/[^0-9.,]/g, '').replace(',', '.');
        const num = parseFloat(clean);
        if (!isNaN(num) && num >= 0 && num < 1e9) {
          amountWords = numberToWordsRubles(num);
        } else {
          amountWords = "[сумма прописью]";
        }
      }

      const accountNumber = document.getElementById("accountNumber").value.trim() || "[номер счёта]";
      const refundReason = document.getElementById("refundReason").value.trim() || "________________________________________";
      const inn = document.getElementById("inn").value.trim() || "________________________";
      const kpp = document.getElementById("kpp").value.trim();
      const bank = document.getElementById("bank").value.trim() || "________________________";
      const checkingAccount = document.getElementById("checkingAccount").value.trim() || "________________________";
      const correspondentAccount = document.getElementById("correspondentAccount").value.trim() || "________________________";
      const bik = document.getElementById("bik").value.trim() || "________________________";
      const directorTitle = document.getElementById("directorTitle").value;
      const directorName = document.getElementById("directorName").value.trim() || "________________________";
      const currentDate = getCurrentDate();

      const { Document, Paragraph, TextRun, Packer, AlignmentType } = window.docx;

      const paragraphs = [];

      paragraphs.push(new Paragraph({ children: [new TextRun(`Исх. №  ________`)] }));
      paragraphs.push(new Paragraph({ children: [new TextRun(`от   ${currentDate}`)] }));
      paragraphs.push(new Paragraph({ children: [new TextRun("")] }));

      paragraphs.push(new Paragraph({
        children: [new TextRun("Генеральному директору")],
        alignment: AlignmentType.RIGHT
      }));
      paragraphs.push(new Paragraph({
        children: [new TextRun('ООО "СМБ-сервис"')],
        alignment: AlignmentType.RIGHT
      }));
      paragraphs.push(new Paragraph({
        children: [new TextRun("Андрееву И.Н.")],
        alignment: AlignmentType.RIGHT
      }));
      paragraphs.push(new Paragraph({ children: [new TextRun("")] }));

      paragraphs.push(new Paragraph({
        children: [new TextRun("Заявление на возврат денежных средств")],
        alignment: AlignmentType.CENTER
      }));
      paragraphs.push(new Paragraph({ children: [new TextRun("")] }));

      const mainText = `${orgName} просит произвести возврат денежных средств по договору ${contractNumber} в размере ${amountNumeric} (${amountWords}), в том числе НДС по ставке в соответствии с действующим законодательством, по счету ${accountNumber}.`;
      paragraphs.push(new Paragraph({
        children: [new TextRun(mainText)],
        alignment: AlignmentType.JUSTIFIED
      }));
      paragraphs.push(new Paragraph({ children: [new TextRun("")] }));

      paragraphs.push(new Paragraph({
        children: [new TextRun(`Причина возврата: ${refundReason}`)],
        alignment: AlignmentType.JUSTIFIED
      }));
      paragraphs.push(new Paragraph({ children: [new TextRun("")] }));

      paragraphs.push(new Paragraph({
        children: [new TextRun(`Реквизиты «${orgName}»`)],
        alignment: AlignmentType.JUSTIFIED
      }));
      paragraphs.push(new Paragraph({
        children: [new TextRun(`ИНН ${inn}`)],
        alignment: AlignmentType.JUSTIFIED
      }));

      if (kpp !== "") {
        paragraphs.push(new Paragraph({
          children: [new TextRun(`КПП ${kpp}`)],
          alignment: AlignmentType.JUSTIFIED
        }));
      }

      paragraphs.push(new Paragraph({
        children: [new TextRun(`Банк ${bank}`)],
        alignment: AlignmentType.JUSTIFIED
      }));
      paragraphs.push(new Paragraph({
        children: [new TextRun(`р/сч ${checkingAccount}`)],
        alignment: AlignmentType.JUSTIFIED
      }));
      paragraphs.push(new Paragraph({
        children: [new TextRun(`кор/сч ${correspondentAccount}`)],
        alignment: AlignmentType.JUSTIFIED
      }));
      paragraphs.push(new Paragraph({
        children: [new TextRun(`БИК ${bik}`)],
        alignment: AlignmentType.JUSTIFIED
      }));
      paragraphs.push(new Paragraph({ children: [new TextRun("")] }));

      paragraphs.push(new Paragraph({
        children: [new TextRun(`${directorTitle}`)],
        alignment: AlignmentType.LEFT
      }));
      paragraphs.push(new Paragraph({
        children: [new TextRun(`______________/${directorName}/`)],
        alignment: AlignmentType.LEFT
      }));
      paragraphs.push(new Paragraph({ children: [new TextRun("")] }));

      paragraphs.push(new Paragraph({ children: [new TextRun("                                                                                                                             М.П.")] }));

      const doc = new Document({
        sections: [{
          children: paragraphs
        }]
      });

      Packer.toBlob(doc).then(blob => {
        window.saveAs(blob, "Заявление_на_возврат_ДС.docx");
      }).catch(err => {
        console.error(err);
        alert("Ошибка при создании документа. Попробуйте обновить страницу.");
      });
    }
  </script>
</body>
</html>
